import numpy as np

import pandas as pd

from sklearn import *

from datetime import datetime

import xgboost as xgb

import gc
# Data wrangling brought to you by the1owl

# https://www.kaggle.com/the1owl/surprise-me



data = {

    'tra': pd.read_csv('../input/air_visit_data.csv'),

    'as': pd.read_csv('../input/air_store_info.csv'),

    'hs': pd.read_csv('../input/hpg_store_info.csv'),

    'ar': pd.read_csv('../input/air_reserve.csv'),

    'hr': pd.read_csv('../input/hpg_reserve.csv'),

    'id': pd.read_csv('../input/store_id_relation.csv'),

    'tes': pd.read_csv('../input/sample_submission.csv'),

    'hol': pd.read_csv('../input/date_info.csv').rename(columns={'calendar_date':'visit_date'})

    }



data['hr'] = pd.merge(data['hr'], data['id'], how='inner', on=['hpg_store_id'])



for df in ['ar','hr']:

    data[df]['visit_datetime'] = pd.to_datetime(data[df]['visit_datetime'])

    data[df]['visit_datetime'] = data[df]['visit_datetime'].dt.date

    data[df]['reserve_datetime'] = pd.to_datetime(data[df]['reserve_datetime'])

    data[df]['reserve_datetime'] = data[df]['reserve_datetime'].dt.date

    data[df]['reserve_datetime_diff'] = data[df].apply(lambda r: (r['visit_datetime'] - r['reserve_datetime']).days, axis=1)

    data[df] = data[df].groupby(['air_store_id','visit_datetime'], as_index=False)[['reserve_datetime_diff', 'reserve_visitors']].sum().rename(columns={'visit_datetime':'visit_date'})

    print(data[df].head())



data['tra']['visit_date'] = pd.to_datetime(data['tra']['visit_date'])

data['tra']['dow'] = data['tra']['visit_date'].dt.dayofweek

data['tra']['year'] = data['tra']['visit_date'].dt.year

data['tra']['month'] = data['tra']['visit_date'].dt.month

data['tra']['visit_date'] = data['tra']['visit_date'].dt.date



data['tes']['visit_date'] = data['tes']['id'].map(lambda x: str(x).split('_')[2])

data['tes']['air_store_id'] = data['tes']['id'].map(lambda x: '_'.join(x.split('_')[:2]))

data['tes']['visit_date'] = pd.to_datetime(data['tes']['visit_date'])

data['tes']['dow'] = data['tes']['visit_date'].dt.dayofweek

data['tes']['year'] = data['tes']['visit_date'].dt.year

data['tes']['month'] = data['tes']['visit_date'].dt.month

data['tes']['visit_date'] = data['tes']['visit_date'].dt.date



unique_stores = data['tes']['air_store_id'].unique()

stores = pd.concat([pd.DataFrame({'air_store_id': unique_stores, 'dow': [i]*len(unique_stores)}) for i in range(7)], axis=0, ignore_index=True).reset_index(drop=True)



#sure it can be compressed...

tmp = data['tra'].groupby(['air_store_id','dow'], as_index=False)['visitors'].min().rename(columns={'visitors':'min_visitors'})

stores = pd.merge(stores, tmp, how='left', on=['air_store_id','dow']) 

tmp = data['tra'].groupby(['air_store_id','dow'], as_index=False)['visitors'].mean().rename(columns={'visitors':'mean_visitors'})

stores = pd.merge(stores, tmp, how='left', on=['air_store_id','dow'])

tmp = data['tra'].groupby(['air_store_id','dow'], as_index=False)['visitors'].median().rename(columns={'visitors':'median_visitors'})

stores = pd.merge(stores, tmp, how='left', on=['air_store_id','dow'])

tmp = data['tra'].groupby(['air_store_id','dow'], as_index=False)['visitors'].max().rename(columns={'visitors':'max_visitors'})

stores = pd.merge(stores, tmp, how='left', on=['air_store_id','dow'])

tmp = data['tra'].groupby(['air_store_id','dow'], as_index=False)['visitors'].count().rename(columns={'visitors':'count_observations'})

stores = pd.merge(stores, tmp, how='left', on=['air_store_id','dow']) 



stores = pd.merge(stores, data['as'], how='left', on=['air_store_id']) 

lbl = preprocessing.LabelEncoder()

stores['air_genre_name'] = lbl.fit_transform(stores['air_genre_name'])

stores['air_area_name'] = lbl.fit_transform(stores['air_area_name'])



data['hol']['visit_date'] = pd.to_datetime(data['hol']['visit_date'])

data['hol']['day_of_week'] = lbl.fit_transform(data['hol']['day_of_week'])

data['hol']['visit_date'] = data['hol']['visit_date'].dt.date



data['tra'] = pd.merge(data['tra'], data['hol'], how='left', on=['visit_date'])

data['tes'] = pd.merge(data['tes'], data['hol'], how='left', on=['visit_date'])



train = pd.merge(data['tra'], stores, how='left', on=['air_store_id','dow']) 

test = pd.merge(data['tes'], stores, how='left', on=['air_store_id','dow'])



for df in ['ar','hr']:

    train = pd.merge(train, data[df], how='left', on=['air_store_id','visit_date']) 

    test = pd.merge(test, data[df], how='left', on=['air_store_id','visit_date'])



col = [c for c in train if c not in ['id', 'air_store_id','visit_date','visitors']]

train = train.fillna(-1)

test = test.fillna(-1)
# XGB starter template borrowed from @anokas

# https://www.kaggle.com/anokas/simple-xgboost-starter-0-0655



print('Binding to float32')



for c, dtype in zip(train.columns, train.dtypes):

    if dtype == np.float64:

        train[c] = train[c].astype(np.float32)

        

for c, dtype in zip(test.columns, test.dtypes):

    if dtype == np.float64:

        test[c] = test[c].astype(np.float32)
train.head()
test.head()
x_train = train.drop(['air_store_id','visit_date','visitors'], axis=1)

y_train = np.log1p(train['visitors'].values)

print(x_train.shape, y_train.shape)
# Create training / validation split

split = 200000

x_train, y_train, x_valid, y_valid = x_train[:split], y_train[:split], x_train[split:], y_train[split:]



print('Building DMatrix...')



d_train = xgb.DMatrix(x_train, label=y_train)

d_valid = xgb.DMatrix(x_valid, label=y_valid)



del x_train, x_valid; gc.collect()
print('Training ...')



params = {}

params['objective'] = 'reg:linear'

params['eval_metric'] = 'rmse'

params['eta'] = 0.04

params['max_depth'] = 7

params['silent'] = 1



watchlist = [(d_train, 'train'), (d_valid, 'valid')]

clf = xgb.train(params, d_train, 10000, watchlist, early_stopping_rounds=100, verbose_eval=10)



del d_train, d_valid
x_test = test.drop(['id','air_store_id','visit_date','visitors'], axis=1)

d_test = xgb.DMatrix(x_test)



del x_test; gc.collect()
print('Predicting on test ...')



p_test = clf.predict(d_test)



del d_test; gc.collect()
np.expm1(p_test)
test['visitors'] = np.expm1(p_test)



test[['id','visitors']].to_csv('xgb_submission.csv', index=False, float_format='%.3f')