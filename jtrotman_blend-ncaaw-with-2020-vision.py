# Auto-generated, do not edit!

# One final run.

INIT = [('chariots17/using-xgboost-lgb-to-predict',

  'using-xgboost-lgb-to-predict',

  8009069,

  ' Using XGBOOST&lgb to predict',

  '2020-02-19T10:19:05.523Z',

  'è°ä¸é‡è¦',

  'chariots17',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/2519363-kg.jpg',

  0.26295,

  17,

  'ðŸ¥‰'),

 ('hiromoon166/2020-women-s-starter-kernel',

  '2020-women-s-starter-kernel',

  7980891,

  "2020 Women's Starter Kernel",

  '2020-02-15T09:33:14.507Z',

  'hiromu',

  'hiromoon166',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1497263-kg.jpg',

  0.44527,

  17,

  'ðŸ¥‰'),

 ('code1110/ncaaw20-eda-and-nn-lgb-catb-starter',

  'ncaaw20-eda-and-nn-lgb-catb-starter',

  8016864,

  '[NCAAW20] EDA and NN+LGB+CatB starter',

  '2020-02-21T12:20:13.09Z',

  'katsu1110',

  'code1110',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/590240-fb.jpg',

  0.19793,

  15,

  'ðŸ¥‰'),

 ('code1110/ncaaw20-finally-no-leak-starter-with-lgb',

  'ncaaw20-finally-no-leak-starter-with-lgb',

  8084358,

  '[NCAAW20] (finally) no-leak starter with LGB',

  '2020-02-24T00:37:52.613Z',

  'katsu1110',

  'code1110',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/590240-fb.jpg',

  0.48157,

  11,

  'ðŸ¥‰'),

 ('moradnejad/eda-plus-nn-lgb-best-score-with-no-leak',

  'eda-plus-nn-lgb-best-score-with-no-leak',

  8279350,

  'EDA plus NN+LGB: BEST score with NO leak',

  '2020-03-06T16:24:45.533Z',

  'Moradnejad',

  'moradnejad',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/2129486-kg.png',

  0.1822,

  9,

  'ðŸ¥‰'),

 ('takaishikawa/no-ml-modeling-ncaaw2020',

  'no-ml-modeling-ncaaw2020',

  8087017,

  'No ML Modeling - NCAAW2020',

  '2020-02-23T11:33:06.42Z',

  'Tak',

  'takaishikawa',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1015481-kg.jpg',

  0.45292,

  8,

  'ðŸ¥‰'),

 ('a45632/2020-starter-kernel-women-improved',

  '2020-starter-kernel-women-improved',

  7981323,

  '2020 Starter Kernel Women Improved',

  '2020-02-15T11:06:30.223Z',

  'Eric Vos',

  'a45632',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/833052-kg.jpg',

  0.40199,

  8,

  'ðŸ¥‰'),

 ('immvab/nn-starter-tensorflow',

  'nn-starter-tensorflow',

  8012595,

  'NN Starter Tensorflow',

  '2020-02-17T18:52:03.137Z',

  'Vaibhav Birla',

  'immvab',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/4422823-kg.png',

  0.43906,

  6,

  ' '),

 ('vbmokin/mm-ncaaw-lgb-xgb-regr',

  'mm-ncaaw-lgb-xgb-regr',

  8310908,

  'MM NCAAW - LGB, XGB & Regr',

  '2020-03-13T13:14:50.523Z',

  'Vitalii Mokin',

  'vbmokin',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1798416-gp.jpg',

  0.12234,

  4,

  ' '),

 ('darwinwin/ncaaw20-eda-and-nn-lgb-catb-starter-7c65f8',

  'ncaaw20-eda-and-nn-lgb-catb-starter-7c65f8',

  8192805,

  '[NCAAW20] EDA and NN+LGB+CatB starter 7c65f8',

  '2020-02-29T14:11:26.193Z',

  'darwinwin',

  'darwinwin',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/4538297-kg.jpg',

  0.20489,

  4,

  ' '),

 ('scirpus/last-year-plus-mens-gp',

  'last-year-plus-mens-gp',

  8178582,

  'Last Year plus mens GP',

  '2020-02-28T12:54:10.947Z',

  'Scirpus',

  'scirpus',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/241438-fb.jpg',

  0.39887,

  4,

  ' '),

 ('hamditarek/ncaaw20-eda-and-nn-lgb-catb-starter-7c65f8',

  'ncaaw20-eda-and-nn-lgb-catb-starter-7c65f8',

  8079138,

  '[NCAAW20] EDA and NN+LGB+CatB starter 7c65f8',

  '2020-02-21T18:29:06.693Z',

  'Tarek Hamdi',

  'hamditarek',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1673888-kg.jpg',

  0.20404,

  4,

  ' '),

 ('darwinwin/ncaaw20-eda-and-nn-lgb-catb-starter',

  'ncaaw20-eda-and-nn-lgb-catb-starter',

  8191645,

  '[NCAAW20] EDA and NN+LGB+CatB starter',

  '2020-02-29T13:19:27.103Z',

  'darwinwin',

  'darwinwin',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/4538297-kg.jpg',

  0.22206,

  3,

  ' '),

 ('sakana/simple-feature-enginering-with-lightgbm',

  'simple-feature-enginering-with-lightgbm',

  8045032,

  'Simple Feature Enginering with LightGBM',

  '2020-02-26T11:58:20.973Z',

  'sakana',

  'sakana',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1377128-kg.jpg',

  0.39544,

  3,

  ' '),

 ('chariots17/artificial-nerual-network-keras',

  'artificial-nerual-network-keras',

  7995656,

  'Artificial Nerual Network(keras)',

  '2020-02-17T11:01:42.583Z',

  'è°ä¸é‡è¦',

  'chariots17',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/2519363-kg.jpg',

  0.44187,

  3,

  ' '),

 ('miklgr500/keras-nn-ncaaw',

  'keras-nn-ncaaw',

  8332826,

  'Keras NN NCAAW',

  '2020-03-10T09:12:53.043Z',

  'Michael Kazachok',

  'miklgr500',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1210896-kg.jpg',

  0.3608,

  2,

  ' '),

 ('miklgr500/bayesian-neural-network-in-keras-ncaaw',

  'bayesian-neural-network-in-keras-ncaaw',

  8303877,

  'Bayesian Neural Network in Keras NCAAW',

  '2020-03-09T11:22:50.843Z',

  'Michael Kazachok',

  'miklgr500',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1210896-kg.jpg',

  0.42929,

  2,

  ' '),

 ('tnmasui/ncaaw-2020-lgb-w-fe-on-three-datasets',

  'ncaaw-2020-lgb-w-fe-on-three-datasets',

  8212330,

  'NCAAW 2020 - LGB w/ FE on three Datasets',

  '2020-03-02T04:59:06.727Z',

  'Tomonori Masui',

  'tnmasui',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/427399-kg.JPG',

  0.44515,

  2,

  ' '),

 ('christoffer/simple-k-optimized-elo-model-ncaaw',

  'simple-k-optimized-elo-model-ncaaw',

  8167258,

  'Simple k-optimized Elo model (NCAAW)',

  '2020-02-27T16:12:19.817Z',

  'Christoffer Karlsson',

  'christoffer',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/94532-kg.png',

  0.53183,

  2,

  ' '),

 ('johnt666/no-leaks-what-do-you-think',

  'no-leaks-what-do-you-think',

  8094832,

  'No leaks, What do you think?',

  '2020-03-01T01:04:45.427Z',

  'Taco',

  'johnt666',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/2015375-kg.jpg',

  0.61052,

  1,

  ' '),

 ('mrboupp/first-submission-using-lightgbm',

  'first-submission-using-lightgbm',

  8315903,

  'First Submission using Lightgbm',

  '2020-03-09T14:36:46.76Z',

  'marbou',

  'mrboupp',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/3563243-kg.jpg',

  0.28961,

  0,

  ' ')]


import pandas as pd

import numpy as np

import os, re, sys

import matplotlib.pyplot as plt

from IPython.core.display import HTML, Image



TAG = 'NCAAW_2020'

DIR  = '../input/google-cloud-ncaa-march-madness-2020-division-1-womens-tournament/WDataFiles_Stage1'

PNG_DIR = '/kaggle/plots'

OUTPUT_ZIP = f'{TAG}_stage1_plots.zip'



os.makedirs(PNG_DIR, exist_ok=True)



def read_results():

    res = pd.read_csv(f'{DIR}/WNCAATourneyCompactResults.csv').query('DayNum>=136')

    TC = ['WTeamID', 'LTeamID']

    res['Low'] = res[TC].min(1)

    res['High'] = res[TC].max(1)

    res['Truth'] = res.eval('Low==WTeamID').astype(int)

    res['Key'] = res.apply(lambda r: f'{r.Season}_{r.Low}_{r.High}', 1)

    res = res.set_index('Key')

    return res



TEAMS = pd.read_csv(f'{DIR}/WTeams.csv', index_col=0)

SEEDS = pd.read_csv(f'{DIR}/WNCAATourneySeeds.csv', index_col=2)

RESULTS = read_results()



TEAMS.shape, SEEDS.shape, RESULTS.shape
plt.rc('figure', figsize=(14, 14))

plt.rc('font', size=12)



ICOLS = ['i1', 'i2']





def expand_sub(df):

    parts = df['id'].str.split('_')

    df['year'] = parts.str[0].astype(int)

    df['t1'] = parts.str[1].astype(int)

    df['t2'] = parts.str[2].astype(int)

    return df[['id', 'year', 't1', 't2', 'pred']].set_index('id')





# return a submission in a standard form

def read_sub(name):

    df = pd.read_csv(name)

    df.columns = df.columns.str.lower()

    return expand_sub(df)





def log_loss(df):

    p = np.where(df.Truth, df.pred, 1 - df.pred)

    # clip low predictions to avoid infinite loss

    p = p.clip(min=1e-15)

    return (-np.log(p)).mean()





def score_sub(sub):

    df = sub.join(RESULTS, how='inner')

    return log_loss(df)





class Year:



    def __init__(self, res, seeds):

        self.res = res

        ids = set(res.Low) | set(res.High)

        self.nteams = len(ids)

        self.seeds = seeds[seeds.index.isin(ids)] # 64 teams

        self.seeds = self.seeds.join(TEAMS)

        self.inds = dict(zip(self.seeds.index, range(self.nteams)))

        # labels for each axis

        self.seeds['lx'] = self.seeds.Seed + " " + self.seeds.TeamName

        self.seeds['ly'] = self.seeds.TeamName + " " + self.seeds.Seed

    

    def add_inds(self, df):

        df = df.assign(i1=df.t1.map(self.inds), i2=df.t2.map(self.inds))

        df = df.dropna()

        df[ICOLS] = df[ICOLS].astype(int)

        return df



    def to_matrix(self, sub):

        sub = self.add_inds(sub)

        nteams = self.nteams

        m = np.ones((nteams, nteams)) * 0.5

        m[sub.i1, sub.i2] = sub.pred

        m[sub.i2, sub.i1] = 1 - sub.pred

        return m



    def heatmap(self, sub, filename, cmap=plt.cm.seismic):

        probs = self.to_matrix(sub)

        fig, ax = plt.subplots()

        heatmap = ax.pcolormesh(probs, vmin=0., vmax=1., cmap=cmap)



        ax.spines['top'].set_visible(False)

        ax.spines['right'].set_visible(False)

        ax.spines['bottom'].set_visible(False)

        ax.spines['left'].set_visible(False)



        ax.invert_yaxis()

        ax.tick_params(direction='out')

        ax.xaxis.tick_top()

        ax.yaxis.tick_left()

        plt.xticks(rotation=90)



        # put the major ticks at the middle of each cell

        ax.set_xticks(np.arange(self.nteams)+0.5, minor=False)

        ax.set_yticks(np.arange(self.nteams)+0.5, minor=False)

        ax.set_xticklabels(self.seeds['lx'])

        ax.set_yticklabels(self.seeds['ly'])

        plt.savefig(filename, bbox_inches='tight')   





YLIST = SEEDS.Season.unique()

YEARS = { year: Year(RESULTS.query(f'Season=={year}'), SEEDS.query(f'Season=={year}')) for year in YLIST }
def reader(lst):

    for scriptUrl, currentUrlSlug, *rest in lst:

        bd = f'../input/{currentUrlSlug}'

        subs = {}

        try:

            files = os.listdir(bd)

            for f in files:

                if f.lower().endswith('.csv'):

                    try:

                        sub = read_sub(f'{bd}/{f}')

                        subs[f] = sub

                    except:

                        pass

        except:

            pass

        if len(subs) > 0:

            yield [scriptUrl, currentUrlSlug] + rest + [subs]



# Ensemble average

sums = 0

count = 0



def show_years(sub, tag):

    display(HTML(

        f'<h2>Prediction Stats</h2>'

        f'<p>Log Loss: {score_sub(sub):.6f}'

    ))

    gb = sub.groupby('year')

    display(gb.pred.agg(['count', 'min', 'max']))

    for year, subdf in gb:

        display(HTML(

            f'<h2>{year}</h2>'

            f'<p>Log Loss: {score_sub(subdf):.6f}'

        ))

        YEARS[year].heatmap(subdf, f'{PNG_DIR}/{tag}_{year}')

        plt.show()



for scriptUrl, currentUrlSlug, _id, title, lastRunTime, displayName, userName, thumbnailUrl, bestPublicScore, totalVotes, medal, subs in reader(INIT):

    display(HTML(

        f'<h1 id="{currentUrlSlug}">{title}</h1>'

        f'<table><tr><td style="vertical-align:top"><img src="{thumbnailUrl}"></td>'

        f'<td style="vertical-align:top"><p><b>{displayName}</b>'

        f'<p><a href="https://www.kaggle.com/{scriptUrl}">{scriptUrl}</a>'

        f'<br>Last run: {pd.to_datetime(lastRunTime).strftime("%c")} '

        f'<br>Votes: {totalVotes} {medal}'

        f'<br>Best public log-loss: {bestPublicScore} '

        f'</td></tr></table>'

    ))

    

    for csv, sub in subs.items():

        show_years(sub, f'{userName}_{currentUrlSlug}')



        sums += sub[['pred']].clip(0, 1)

        count += 1
ensemble = (sums / count)

count, score_sub(ensemble)
show_years(expand_sub(ensemble.reset_index()), f'{TAG}_ensemble')
ensemble.to_csv(f'{TAG}_blend.csv')
